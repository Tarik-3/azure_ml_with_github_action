name: ML Pipeline (Unified)

on:
  push:
    branches:
      - main
    paths:
      - 'data/**'
      - '*.py'
      - '.github/workflows/ml_pipeline.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - 'train-only'
          - 'train-and-predict'
          - 'predict-only'
        default: 'train-and-predict'
      data_file:
        description: 'Path to inference data file (for predict)'
        required: false
        default: 'data/new_data.csv'
        type: string
      retrain_reason:
        description: 'Reason for retraining (optional)'
        required: false
        default: 'Manual retrain'
        type: string

jobs:
  check-model:
    name: Check Model Status
    runs-on: ubuntu-latest
    outputs:
      model_exists: ${{ steps.check.outputs.exists }}
      should_train: ${{ steps.decide.outputs.train }}
      should_predict: ${{ steps.decide.outputs.predict }}
    steps:
      - name: Check if model exists
        id: check
        continue-on-error: true
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ml_pipeline.yml
          name: train-output
          path: model_check/
          search_artifacts: true
          workflow_conclusion: success

      - name: Determine model existence
        id: flag
        run: |
          if [ "${{ steps.check.outcome }}" = "success" ] && [ -f model_check/model.pkl ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Model found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No model found"
          fi

      - name: Decide what to run
        id: decide
        run: |
          MODEL_EXISTS="${{ steps.flag.outputs.exists }}"
          EVENT="${{ github.event_name }}"
          ACTION="${{ github.event.inputs.action }}"
          
          echo "Event: $EVENT"
          echo "Action: $ACTION"
          echo "Model exists: $MODEL_EXISTS"
          
          TRAIN="false"
          PREDICT="false"
          
          if [ "$EVENT" = "workflow_dispatch" ]; then
            # Manual trigger
            if [ "$ACTION" = "train-only" ] || [ "$ACTION" = "train-and-predict" ]; then
              TRAIN="true"
            fi
            if [ "$ACTION" = "predict-only" ] || [ "$ACTION" = "train-and-predict" ]; then
              PREDICT="true"
            fi
          else
            # Push trigger (automatic)
            if [ "$MODEL_EXISTS" = "false" ]; then
              # No model - need to train first
              TRAIN="true"
              PREDICT="true"
            else
              # Model exists - just predict
              PREDICT="true"
            fi
          fi
          
          echo "train=$TRAIN" >> $GITHUB_OUTPUT
          echo "predict=$PREDICT" >> $GITHUB_OUTPUT
          
          echo "ðŸŽ¯ Decision: Train=$TRAIN, Predict=$PREDICT"

      - name: Summary
        run: |
          echo "### Pipeline Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Model Exists**: ${{ steps.flag.outputs.exists }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Will Train**: ${{ steps.decide.outputs.train }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Will Predict**: ${{ steps.decide.outputs.predict }}" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # TRAINING JOBS (Conditional)
  # ============================================================================

  prepare-training-data:
    name: Prepare Training Data
    runs-on: ubuntu-latest
    needs: check-model
    if: needs.check-model.outputs.should_train == 'true'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run prep step
        run: |
          mkdir -p outputs/prep_output
          python prep.py --input data/sample_data.csv --output outputs/prep_output

      - name: Upload prepared data
        uses: actions/upload-artifact@v4
        with:
          name: prep-output
          path: outputs/prep_output/

  train-model:
    name: Train Model
    runs-on: ubuntu-latest
    needs: prepare-training-data
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: prep-output
          path: outputs/prep_output/

      - name: Run train step
        run: |
          mkdir -p outputs/train_output
          python train.py --input outputs/prep_output --output outputs/train_output

      - name: Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: train-output
          path: outputs/train_output/
          retention-days: 90

  test-model:
    name: Test Model
    runs-on: ubuntu-latest
    needs: [prepare-training-data, train-model]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download prepared data
        uses: actions/download-artifact@v4
        with:
          name: prep-output
          path: outputs/prep_output/

      - name: Download trained model
        uses: actions/download-artifact@v4
        with:
          name: train-output
          path: outputs/train_output/

      - name: Run test step
        run: |
          python test.py --input outputs/prep_output --model outputs/train_output

      - name: Upload metrics
        uses: actions/upload-artifact@v4
        with:
          name: metrics
          path: outputs/metrics.json

  # ============================================================================
  # INFERENCE JOBS (Conditional)
  # ============================================================================

  prepare-inference-data:
    name: Prepare Inference Data
    runs-on: ubuntu-latest
    needs: check-model
    if: needs.check-model.outputs.should_predict == 'true'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Determine input file
        id: input
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "file=${{ github.event.inputs.data_file }}" >> $GITHUB_OUTPUT
          else
            echo "file=data/new_data.csv" >> $GITHUB_OUTPUT
          fi

      - name: Validate and prepare data
        run: |
          python prepare_inference_data.py \
            --input "${{ steps.input.outputs.file }}" \
            --output outputs/inference_data

      - name: Upload cleaned data
        uses: actions/upload-artifact@v4
        with:
          name: inference-data
          path: outputs/inference_data/

  get-model:
    name: Get Model for Inference
    runs-on: ubuntu-latest
    needs: [check-model, prepare-inference-data, test-model]
    if: |
      needs.check-model.outputs.should_predict == 'true' &&
      (always() && !cancelled())
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Download model (from training or existing)
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ml_pipeline.yml
          name: train-output
          path: models/
          search_artifacts: true
          workflow_conclusion: success

      - name: Verify model
        run: |
          if [ ! -f "models/model.pkl" ]; then
            echo "âŒ Model file not found"
            exit 1
          fi
          echo "âœ… Model loaded successfully"
          ls -lh models/

      - name: Upload model
        uses: actions/upload-artifact@v4
        with:
          name: model
          path: models/

  predict:
    name: Make Predictions
    runs-on: ubuntu-latest
    needs: [prepare-inference-data, get-model]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download cleaned data
        uses: actions/download-artifact@v4
        with:
          name: inference-data
          path: outputs/inference_data/

      - name: Download model
        uses: actions/download-artifact@v4
        with:
          name: model
          path: models/

      - name: Run predictions
        run: |
          mkdir -p outputs/predictions
          python predict.py \
            --data outputs/inference_data/cleaned_data.csv \
            --model models \
            --output outputs/predictions

      - name: Upload predictions
        uses: actions/upload-artifact@v4
        with:
          name: predictions
          path: outputs/predictions/

  # ============================================================================
  # RESULTS SUMMARY
  # ============================================================================

  results:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [check-model, test-model, predict]
    if: always()
    steps:
      - name: Download all artifacts
        continue-on-error: true
        uses: actions/download-artifact@v4

      - name: Create comprehensive summary
        run: |
          echo "## ðŸ¤– ML Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Training Results
          if [ "${{ needs.check-model.outputs.should_train }}" = "true" ]; then
            echo "### ðŸŽ“ Training Phase" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.test-model.result }}" = "success" ]; then
              echo "âœ… **Status**: Training completed successfully" >> $GITHUB_STEP_SUMMARY
              if [ -f metrics/metrics.json ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Model Metrics**:" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
                cat metrics/metrics.json >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ **Status**: Training failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Inference Results
          if [ "${{ needs.check-model.outputs.should_predict }}" = "true" ]; then
            echo "### ðŸ”® Inference Phase" >> $GITHUB_STEP_SUMMARY
            if [ "${{ needs.predict.result }}" = "success" ]; then
              echo "âœ… **Status**: Predictions completed successfully" >> $GITHUB_STEP_SUMMARY
              if [ -f predictions/prediction_summary.json ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Prediction Statistics**:" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
                cat predictions/prediction_summary.json >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ **Status**: Prediction failed" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Artifacts
          echo "### ðŸ“¦ Available Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -R | grep -E "^\./" >> $GITHUB_STEP_SUMMARY || echo "No artifacts found" >> $GITHUB_STEP_SUMMARY
