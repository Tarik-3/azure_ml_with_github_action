name: Inference Pipeline

on:
  workflow_dispatch:
    inputs:
      data_file:
        description: 'Path to new data file (relative to repo root)'
        required: false
        default: 'data/new_data.csv'
        type: string

jobs:
  predict:
    name: Make Predictions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Download latest model
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: azureml.yml
          name: train-output
          path: models/
          search_artifacts: true

      - name: Verify input data exists
        run: |
          if [ ! -f "${{ github.event.inputs.data_file }}" ]; then
            echo "Error: Data file not found at ${{ github.event.inputs.data_file }}"
            exit 1
          fi
          echo "Data file found: ${{ github.event.inputs.data_file }}"

      - name: Run predictions
        run: |
          mkdir -p outputs/predictions
          python predict.py \
            --model models \
            --input "${{ github.event.inputs.data_file }}" \
            --output outputs/predictions

      - name: Upload predictions
        uses: actions/upload-artifact@v4
        with:
          name: predictions-${{ github.run_number }}
          path: outputs/predictions/

      - name: Create summary
        run: |
          echo "## Prediction Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Input Data**: \`${{ github.event.inputs.data_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f outputs/predictions/prediction_summary.json ]; then
            echo "### Summary Statistics" >> $GITHUB_STEP_SUMMARY
            cat outputs/predictions/prediction_summary.json >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts**: Download \`predictions-${{ github.run_number }}\` to see full results" >> $GITHUB_STEP_SUMMARY
